name: Force sync from upstream main (skip workflows)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/30 * * * *" # 30분마다

permissions:
  contents: write

concurrency:
  group: force-sync-main
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream (3rd original) and fetch
        run: |
          git remote add upstream https://github.com/prgrms-be-devcourse/NBE8-10-3-Team05.git || true
          git fetch upstream main

      - name: Sync files from upstream/main but NEVER touch .github/workflows
        run: |
          set -e
          git checkout main

          # upstream/main의 파일 목록을 가져와서 workflows를 제외하고 체크아웃
          git ls-tree -r --name-only upstream/main \
            | grep -vE '^\.github/workflows/|^frontend/vercel\.json$' \
            | sed 's/^/"/; s/$/"/' \
            > /tmp/files.txt

          # 파일이 너무 많아도 안전하게 xargs로 처리
          cat /tmp/files.txt | xargs -n 200 git checkout upstream/main --

          # upstream에선 삭제됐는데 fork에는 남아있는 파일도 정리(워크플로우 제외)
          git ls-tree -r --name-only main \
            | grep -vE '^\.github/workflows/|^frontend/vercel\.json$' \
            | sort > /tmp/main_files.txt

          git ls-tree -r --name-only upstream/main \
            | grep -vE '^\.github/workflows/|^frontend/vercel\.json$' \
            | sort > /tmp/up_files.txt

          comm -23 /tmp/main_files.txt /tmp/up_files.txt > /tmp/to_delete.txt || true
          if [ -s /tmp/to_delete.txt ]; then
            cat /tmp/to_delete.txt | xargs -n 200 rm -f
          fi

          git add -A

          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "chore: sync from upstream/main (skip workflows)"
            git push origin main
          else
            echo "No changes to commit."
          fi